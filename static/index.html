<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miss & Mister Arts et Humanit√©s Num√©riques 2025 ‚Äî Vote</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280;
  --accent-1:#ff7a00; --accent-2:#3b6bf0; --accent-3:#ff3c78;
  --glass:rgba(255,255,255,0.85); --shadow:rgba(0,0,0,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:var(--bg);color:#0f172a;}
.page{max-width:1200px;margin:0 auto;padding:20px;}
header.hero{
  position:relative; border-radius:24px; padding:60px 20px;
  text-align:center; color:white;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2),var(--accent-3),var(--accent-1));
  background-size:400% 400%; animation:gradientBG 15s ease infinite;
  box-shadow:0 12px 40px rgba(0,0,0,0.2); margin-bottom:20px;
}
@keyframes gradientBG{
  0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
}
.hero h1{font-size:2.8rem;margin-bottom:12px;text-shadow:0 3px 12px rgba(0,0,0,0.25);}
.hero .subtitle{font-size:1.3rem;color:rgba(255,255,255,0.9);margin-bottom:15px;}
.hero .meta{display:flex;justify-content:center;gap:40px;font-weight:700;font-size:1.1rem;margin-bottom:20px;}

/* Compte √† rebours */
.countdown-container {
  background:rgba(255,255,255,0.15); backdrop-filter:blur(10px);
  border-radius:16px; padding:20px; margin:20px auto; max-width:600px;
  border:2px solid rgba(255,255,255,0.2);
}
.countdown-title {
  font-size:1.2rem; margin-bottom:15px; font-weight:600;
  display:flex; align-items:center; justify-content:center; gap:10px;
}
.countdown-grid {
  display:grid; grid-template-columns:repeat(4, 1fr); gap:15px;
}
.countdown-item {
  background:rgba(255,255,255,0.2); border-radius:12px; padding:15px;
  text-align:center; backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.1);
}
.countdown-value {
  font-size:2.5rem; font-weight:800; line-height:1;
  text-shadow:0 2px 8px rgba(0,0,0,0.3);
}
.countdown-label {
  font-size:0.9rem; margin-top:5px; opacity:0.9;
}
.vote-ended {
  background:rgba(220,53,69,0.2); border:2px solid #dc3545;
  padding:20px; border-radius:16px; margin:20px auto; max-width:600px;
  text-align:center; font-weight:600; font-size:1.2rem;
}

.admin-btn{
  position:absolute;top:20px;right:20px; background:rgba(255,255,255,0.25);
  backdrop-filter:blur(6px); border:none;color:white; padding:12px 20px;
  border-radius:14px; font-weight:700;cursor:pointer; transition:0.3s;
}
.admin-btn:hover{background:rgba(255,255,255,0.4);transform:scale(1.05);}
.grid{display:grid;grid-template-columns:1fr;gap:24px;margin-top:40px;}
.card{background:var(--card);border-radius:20px;padding:32px;box-shadow:0 12px 36px var(--shadow);}
.candidates{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:24px;}
.candidate{
  background:#fff;border-radius:20px;overflow:hidden; box-shadow:0 8px 20px var(--shadow);
  display:flex;flex-direction:column; transition:transform 0.4s,box-shadow 0.4s; position:relative;
}
.candidate:hover{transform:translateY(-12px);box-shadow:0 20px 40px var(--shadow);}
.thumb{width:100%;height:240px;background:#eef6ff;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.thumb img{width:100%;height:100%;object-fit:cover;transition:transform 0.4s;}
.candidate:hover .thumb img{transform:scale(1.07);}
.info{padding:20px;flex:1;display:flex;flex-direction:column;justify-content:space-between;}
.info h3{font-size:1.2rem;margin-bottom:8px;display:flex;flex-direction:column;gap:5px;}
.number-badge{background:var(--accent-1);color:white;padding:4px 12px;border-radius:12px;font-size:0.9rem;font-weight:bold;display:inline-block;}
.votes-badge{margin-top:6px;font-weight:700;color:var(--accent-2);transition:transform 0.3s,color 0.3s;}
.votes-badge.animate{transform:scale(1.3);color:var(--accent-3);}
.actions{display:flex;justify-content:flex-end;margin-top:16px;}
.vote-btn{
  padding:12px 18px; background:linear-gradient(90deg,var(--accent-1),var(--accent-3));
  border:none;color:white;font-weight:700;border-radius:14px;cursor:pointer;transition:all 0.3s;
}
.vote-btn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,0.2);}
.vote-btn:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none;}
#ranking{margin-top:32px;}
.ranking-item{
  margin-bottom:16px; padding:12px; background:#fff; border-radius:12px;
  box-shadow:0 4px 12px var(--shadow); transition:all 0.5s;
}
.ranking-info{display:flex;align-items:center;margin-bottom:5px;}
.ranking-rank{
  display:inline-block; width:32px;height:32px; background:var(--accent-1); color:white;
  border-radius:50%; text-align:center; line-height:32px; margin-right:10px;
  font-weight:bold; font-size:1rem;
}
.ranking-rank.rank-1{background:#ffd700;color:#000;}
.ranking-rank.rank-2{background:#c0c0c0;color:#000;}
.ranking-rank.rank-3{background:#cd7f32;color:#000;}
.ranking-candidate-number{
  background:var(--accent-2); color:white; padding:3px 8px; border-radius:8px;
  font-size:0.8rem; margin-right:8px; font-weight:bold;
}
.ranking-bar-container{width:100%;height:14px;background:#e9ecef;border-radius:8px;overflow:hidden;margin-top:5px;}
.ranking-bar{height:100%;background:var(--accent-2);border-radius:8px;transition:width 1s;}
.candidate-number{
  position:absolute; top:10px;left:10px; background:var(--accent-1); color:white;
  width:36px;height:36px; border-radius:50%; display:flex; align-items:center;
  justify-content:center; font-weight:bold; font-size:1.1rem;
  box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:10;
}
#payment-modal,#admin-panel{
  position:fixed;top:0;left:0;width:100%;height:100%; background:rgba(0,0,0,0.55);
  display:none; align-items:center;justify-content:center;z-index:9999;
  animation:fadeIn 0.3s;
}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
.modal-content{
  background:white;width:450px;padding:32px;border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,0.25); max-width:90%;
}
.modal-content h3{margin-bottom:18px;color:var(--accent-2);}
.modal-content label{margin-top:12px;display:block;font-weight:600;}
.modal-content input,.modal-content select{
  width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;margin-bottom:10px;
}
.modal-content button{
  padding:12px 18px;width:100%;border-radius:14px;border:none;
  background:var(--accent-2);color:white;font-weight:700;cursor:pointer;
  transition:all 0.3s;margin-top:10px;
}
.modal-content button:hover{transform:scale(1.05);}
.admin-section{margin-top:20px;max-height:450px;overflow-y:auto;}
.admin-card{
  margin-bottom:14px;padding:12px;border:1px solid #eee;border-radius:12px;
  display:flex;justify-content:space-between;align-items:center;transition:all 0.3s;
}
.admin-card button{padding:8px 14px;border:none;background:var(--accent-2);color:white;border-radius:10px;cursor:pointer;margin-left:8px;transition:0.3s;}
.admin-card button.reject{background:#ff3c3c;}
#payment-number{margin-bottom:10px;font-weight:600;}
footer{text-align:center;margin-top:40px;color:var(--muted);padding:20px;border-top:1px solid #eee;}
.loading{text-align:center;padding:40px;color:var(--muted);}
.loading-spinner{
  border:4px solid #f3f3f3;border-top:4px solid var(--accent-2);border-radius:50%;
  width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.status-badge{
  position:fixed;top:10px;right:10px;z-index:1000; padding:8px 16px;
  border-radius:20px;font-size:0.9rem;font-weight:600;
  background:#d4edda;color:#155724;border:1px solid #c3e6cb;
}
.status-badge.offline{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.status-badge.connecting{background:#fff3cd;color:#856404;border:1px solid #ffeaa7;}
.warning-box{
  background:#fff3cd;color:#856404;border:1px solid #ffeaa7;
  padding:15px;border-radius:10px;margin:15px 0;text-align:center;
}
@media(max-width:900px){.grid{grid-template-columns:1fr;}.candidates{grid-template-columns:1fr;}}
@media(max-width:768px){
  .hero h1{font-size:2.2rem;}
  .countdown-grid{gap:10px;}
  .countdown-value{font-size:2rem;}
  .hero .meta{flex-direction:column;gap:15px;}
}
@media(max-width:480px){
  .countdown-grid{grid-template-columns:repeat(2,1fr);}
  .hero h1{font-size:1.8rem;}
}
</style>
</head>
<body>
<div id="status-badge" class="status-badge connecting">‚è≥ Connexion...</div>

<div class="page">
<header class="hero">
<h1>Miss & Mister AHN 2025</h1>
<div class="subtitle">Votez pour vos candidats pr√©f√©r√©s !</div>
<div class="meta">
<div> <strong id="candidates-count">0</strong> Candidats</div>
<div> <strong id="votes-count">0</strong> Votes</div>
</div>

<!-- Compte √† rebours -->
<div id="countdown" class="countdown-container">
  <div class="countdown-title">
    <span>‚è≥ TEMPS RESTANT POUR VOTER</span>
  </div>
  <div class="countdown-grid">
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-days">00</div>
      <div class="countdown-label">JOURS</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-hours">00</div>
      <div class="countdown-label">HEURES</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-minutes">00</div>
      <div class="countdown-label">MINUTES</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-seconds">00</div>
      <div class="countdown-label">SECONDES</div>
    </div>
  </div>
</div>

<div id="vote-ended" class="vote-ended" style="display:none;">
  ‚è∞ <strong>LES VOTES SONT TERMIN√âS</strong><br>
  La p√©riode de vote s'est achev√©e le 20 d√©cembre 2025 √† 21h00
</div>

<button class="admin-btn"> Admin</button>
</header>

<div id="connection-warning" class="warning-box" style="display:none;">
‚ö†Ô∏è <strong>Mode local activ√©</strong> - La base de donn√©es n'est pas disponible.
</div>

<div class="grid">
<main>
<div class="card">
<h2 style="color:var(--accent-2);margin-bottom:12px;">Candidates Miss</h2>
<div class="candidates" id="miss-list">
  <div class="loading"><div class="loading-spinner"></div>Chargement...</div>
</div>
<h2 style="color:var(--accent-2);margin-top:32px;margin-bottom:12px;">Candidates Mister</h2>
<div class="candidates" id="mister-list">
  <div class="loading"><div class="loading-spinner"></div>Chargement...</div>
</div>
<h2 style="color:var(--accent-3);margin-top:32px;">Classement</h2>
<div id="ranking">
  <div class="loading"><div class="loading-spinner"></div>Chargement...</div>
</div>
</div>
</main>
</div>
<footer>
<div>¬© Comit√© de Parrainage Arts et Humanit√©s Num√©riques 2025</div>
<div style="margin-top:10px;font-size:0.9rem;color:#666;">
  Date limite : 20 d√©cembre 2025 √† 21h00 (Heure Cameroun) ‚Ä¢ 
  <a href="https://election-mister.onrender.com/api/debug/files" style="color:var(--accent-2);">V√©rifier les fichiers</a> ‚Ä¢ 
  <a href="https://election-mister.onrender.com/api/fix-images" style="color:var(--accent-2);">Corriger images</a>
</div>
</footer>
</div>

<!-- Payment Modal -->
<div id="payment-modal">
<div class="modal-content">
<h3>Paiement pour le vote</h3>
<label>Nombre de votes :</label>
<input type="number" id="vote-count" min="1" value="1">
<label>Montant √† payer :</label>
<input type="text" id="payment-amount" value="100 FCFA" readonly>
<label>Moyen de paiement :</label>
<select id="payment-method">
<option value="orange_money">Orange Money</option>
<option value="mtn_money">MTN Money</option>
<option value="wave">Wave</option>
</select>
<div id="payment-number">Num√©ro Orange Money : #150*46*0761200#</div>
<label>Code transaction :</label>
<input type="text" id="payment-code" placeholder="Entrez le code re√ßu par SMS">
<button id="submit-payment">Envoyer pour validation</button>
<button style="background:#eee;color:#333;" onclick="closePaymentModal()">Annuler</button>
</div>
</div>

<!-- Admin Panel -->
<div id="admin-panel">
<div class="modal-content">
<h2 style="color:var(--accent-2);">Panneau Admin</h2>
<label>Mot de passe :</label>
<input type="password" id="admin-pass">
<button id="admin-login">Se connecter</button>
<div id="admin-content" style="display:none;">
<h3 style="margin-top:20px;">Transactions en attente</h3>
<div class="admin-section" id="pending-list-section">
  <div class="loading">Chargement...</div>
</div>
</div>
<button onclick="closeAdminPanel()" style="margin-top:20px;">Fermer</button>
</div>
</div>

<script>
// ============================
// CONFIGURATION
// ============================
const API_BASE_URL = window.location.origin + '/api';
const IMAGES_BASE_PATH = '/static/photo/';
const PRICE_PER_VOTE = 100;
const VOTE_DEADLINE = new Date('2025-12-20T21:00:00+01:00'); // 21h00 Cameroun (UTC+1)

let allCandidates = [];
let pendingTransactions = [];
let currentCandidateId = null;
let isDatabaseConnected = false;
let adminToken = null;
let voteActive = true;
let countdownInterval = null;

// ============================
// COMPTE √Ä REBOURS
// ============================
function updateCountdown() {
  const now = new Date();
  const timeRemaining = VOTE_DEADLINE - now;
  
  if (timeRemaining <= 0) {
    // Vote termin√©
    voteActive = false;
    document.getElementById('countdown').style.display = 'none';
    document.getElementById('vote-ended').style.display = 'block';
    
    // D√©sactiver tous les boutons de vote
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.disabled = true;
      btn.textContent = 'Vote termin√©';
      btn.style.background = '#ccc';
    });
    
    // Arr√™ter l'intervalle
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }
    
    return;
  }
  
  // Calculer jours, heures, minutes, secondes
  const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
  const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
  
  // Mettre √† jour l'affichage
  document.getElementById('countdown-days').textContent = days.toString().padStart(2, '0');
  document.getElementById('countdown-hours').textContent = hours.toString().padStart(2, '0');
  document.getElementById('countdown-minutes').textContent = minutes.toString().padStart(2, '0');
  document.getElementById('countdown-seconds').textContent = seconds.toString().padStart(2, '0');
  
  // Animation pour les secondes
  const secondsElement = document.getElementById('countdown-seconds');
  secondsElement.style.transform = 'scale(1.1)';
  setTimeout(() => {
    secondsElement.style.transform = 'scale(1)';
  }, 300);
}

function startCountdown() {
  // Mettre √† jour imm√©diatement
  updateCountdown();
  
  // Puis mettre √† jour toutes les secondes
  countdownInterval = setInterval(updateCountdown, 1000);
}

// ============================
// FONCTIONS UTILITAIRES
// ============================
function extractCandidateNumber(candidateId) {
  if (!candidateId) return '?';
  const matches = candidateId.match(/\d+/g);
  if (matches && matches.length > 0) return matches[matches.length - 1];
  const lastDigit = candidateId.match(/\d$/);
  return lastDigit ? lastDigit[0] : '?';
}

async function fetchAPI(endpoint, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000);
  
  try {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        ...(adminToken && { 'Authorization': `Bearer ${adminToken}` }),
        ...options.headers
      },
      ...options
    });
    
    clearTimeout(timeoutId);
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') throw new Error('Timeout: Le serveur ne r√©pond pas');
    throw error;
  }
}

async function testConnection() {
  try {
    const data = await fetchAPI('/health');
    updateConnectionStatus(data.database === 'connected');
    return data.database === 'connected';
  } catch (error) {
    console.log('API non disponible:', error.message);
    updateConnectionStatus(false);
    return false;
  }
}

function updateConnectionStatus(connected) {
  const badge = document.getElementById('status-badge');
  const warning = document.getElementById('connection-warning');
  isDatabaseConnected = connected;
  
  if (connected) {
    badge.className = 'status-badge';
    badge.textContent = '‚úì Connect√© BD';
    warning.style.display = 'none';
  } else {
    badge.className = 'status-badge offline';
    badge.textContent = '‚ö†Ô∏è Mode local';
    warning.style.display = 'block';
  }
}

// ============================
// CHARGEMENT ET AFFICHAGE
// ============================
async function loadCandidates() {
  try {
    const isConnected = await testConnection();
    
    if (isConnected) {
      allCandidates = await fetchAPI('/candidates');
      console.log('Candidats charg√©s:', allCandidates);
      
      // Tester les images
      console.log('üîç Test des images:');
      allCandidates.forEach(candidate => {
        if (candidate.img) {
          // Corriger le chemin si n√©cessaire
          let imgPath = candidate.img;
          if (imgPath.startsWith('Photo/')) {
            imgPath = imgPath.replace('Photo/', '');
            console.log(`  Correction: ${candidate.img} -> ${imgPath}`);
          }
          
          const imgUrl = IMAGES_BASE_PATH + imgPath;
          console.log(`  ${candidate.nom}: ${imgUrl}`);
          
          // Pr√©charger
          const img = new Image();
          img.onload = () => console.log(`    ‚úÖ Charg√©e`);
          img.onerror = () => console.log(`    ‚ùå Erreur`);
          img.src = imgUrl;
        }
      });
      
      await loadStats();
      await loadRanking();
    } else {
      const saved = localStorage.getItem('ahn_candidates');
      allCandidates = saved ? JSON.parse(saved) : [];
      updateTotalVotes();
      updateRanking();
    }
    
    displayCandidates();
    
  } catch (error) {
    console.error('Erreur chargement:', error);
    const saved = localStorage.getItem('ahn_candidates');
    allCandidates = saved ? JSON.parse(saved) : [];
    displayCandidates();
    updateTotalVotes();
    updateRanking();
  }
}

function displayCandidates() {
  document.getElementById('candidates-count').textContent = allCandidates.length;
  
  const missList = document.getElementById('miss-list');
  const misterList = document.getElementById('mister-list');
  
  const missCandidates = allCandidates.filter(c => c.categorie === 'miss');
  const misterCandidates = allCandidates.filter(c => c.categorie === 'mister');
  
  missList.innerHTML = missCandidates.map(createCandidateCard).join('');
  misterList.innerHTML = misterCandidates.map(createCandidateCard).join('');
  
  // Ajouter les √©v√©nements
  setTimeout(() => {
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (!voteActive) {
          alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
          return;
        }
        openPaymentModal(e.target.getAttribute('data-id'));
      });
    });
  }, 100);
}

function createCandidateCard(candidate) {
  const candidateNumber = candidate.candidate_number || extractCandidateNumber(candidate.id);
  
  // CORRECTION DES CHEMINS D'IMAGES
  let imageFilename = candidate.img || '';
  if (imageFilename.startsWith('Photo/')) {
    imageFilename = imageFilename.replace('Photo/', '');
  }
  
  const imageUrl = imageFilename ? IMAGES_BASE_PATH + imageFilename : null;
  const candidateName = candidate.nom || 'Candidat';
  const initials = candidateName.split(' ').map(w => w[0]).join('').toUpperCase().substr(0, 2);
  
  // URL de secours (avatar avec initiales)
  const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(candidateName)}&background=3b6bf0&color=fff&bold=true&size=300`;
  
  return `
    <div class="candidate">
      <div class="candidate-number">${candidateNumber}</div>
      <div class="thumb">
        <img src="${imageUrl || fallbackUrl}" 
             alt="${candidateName}"
             onerror="
               if (this.src !== '${fallbackUrl}') {
                 this.src = '${fallbackUrl}';
               }
             "
             loading="lazy">
      </div>
      <div class="info">
        <h3>
          <span class="number-badge">Candidat N¬∞${candidateNumber}</span>
          ${candidateName}
        </h3>
        <div class="votes-badge" data-votes-id="${candidate.id}">Votes: ${candidate.votes || 0}</div>
      </div>
      <div class="actions">
        <button class="vote-btn" data-id="${candidate.id}" ${!voteActive ? 'disabled' : ''}>
          ${voteActive ? 'Voter' : 'Vote termin√©'}
        </button>
      </div>
    </div>
  `;
}

async function loadStats() {
  try {
    const stats = await fetchAPI('/stats');
    document.getElementById('votes-count').textContent = stats.total_votes || 0;
  } catch (error) {
    console.log('Stats:', error);
    updateTotalVotes();
  }
}

function updateTotalVotes() {
  const total = allCandidates.reduce((sum, c) => sum + (c.votes || 0), 0);
  document.getElementById('votes-count').textContent = total;
}

async function loadRanking() {
  try {
    const ranking = await fetchAPI('/ranking');
    displayRanking(ranking);
  } catch (error) {
    console.log('Classement:', error);
    updateRanking();
  }
}

function updateRanking() {
  const ranking = [...allCandidates]
    .sort((a, b) => (b.votes || 0) - (a.votes || 0))
    .map((c, i) => ({
      ...c,
      rank_position: i + 1,
      candidate_number: c.candidate_number || extractCandidateNumber(c.id)
    }));
  displayRanking(ranking);
}

function displayRanking(ranking) {
  const rankingDiv = document.getElementById('ranking');
  
  if (ranking.length > 0) {
    const maxVotes = Math.max(...ranking.map(c => c.votes || 0), 1);
    
    rankingDiv.innerHTML = ranking.map(c => {
      const percentage = ((c.votes || 0) / maxVotes) * 100;
      return `
        <div class="ranking-item">
          <div class="ranking-info">
            <span class="ranking-rank ${c.rank_position <= 3 ? 'rank-' + c.rank_position : ''}">
              ${c.rank_position}
            </span>
            <span class="ranking-candidate-number">Candidat N¬∞${c.candidate_number}</span>
            <strong>${c.nom}</strong>
            <span style="margin-left:auto;color:var(--accent-2);font-weight:bold;">
              ${c.votes || 0} vote(s)
            </span>
          </div>
          <div class="ranking-bar-container">
            <div class="ranking-bar" style="width:${percentage}%"></div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    rankingDiv.innerHTML = '<div class="loading">Aucun vote pour le moment</div>';
  }
}

// ============================
// GESTION DES VOTES
// ============================
async function checkTransactionCode(code) {
  if (!code || !isDatabaseConnected) return { exists: false };
  try {
    return await fetchAPI(`/check-transaction/${encodeURIComponent(code)}`);
  } catch (error) {
    console.log('V√©rif code:', error);
    return { exists: false };
  }
}

function openPaymentModal(candidateId) {
  if (!voteActive) {
    alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
    return;
  }
  
  currentCandidateId = candidateId;
  document.getElementById('vote-count').value = 1;
  document.getElementById('payment-code').value = '';
  document.getElementById('payment-amount').value = PRICE_PER_VOTE + ' FCFA';
  updatePaymentNumber();
  document.getElementById('payment-modal').style.display = 'flex';
}

function closePaymentModal() {
  document.getElementById('payment-modal').style.display = 'none';
  currentCandidateId = null;
}

document.getElementById('vote-count').addEventListener('input', function() {
  let count = parseInt(this.value) || 1;
  if (count < 1) count = 1;
  this.value = count;
  document.getElementById('payment-amount').value = (count * PRICE_PER_VOTE) + " FCFA";
});

function updatePaymentNumber() {
  const method = document.getElementById('payment-method').value;
  let number = '';
  switch(method) {
    case 'orange_money': number = '#150*46*0761200#'; break;
    case 'mtn_money': number = '#556#'; break;
    case 'wave': number = '+221 78 123 45 67'; break;
    default: number = '#150*46*0761200#';
  }
  document.getElementById('payment-number').textContent = 'Num√©ro ' + method.replace('_', ' ') + ' : ' + number;
}

document.getElementById('payment-method').addEventListener('change', updatePaymentNumber);

document.getElementById('submit-payment').addEventListener('click', async function() {
  if (!voteActive) {
    alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
    closePaymentModal();
    return;
  }
  
  const method = document.getElementById('payment-method').value;
  const code = document.getElementById('payment-code').value.trim();
  const voteCount = parseInt(document.getElementById('vote-count').value) || 1;
  
  if (!code) return alert('Veuillez entrer le code de transaction');
  if (!currentCandidateId) return alert('Erreur: Candidat non s√©lectionn√©');
  
  const candidate = allCandidates.find(c => c.id === currentCandidateId);
  if (!candidate) return alert('Erreur: Candidat introuvable');
  
  // V√©rifier si le code existe d√©j√†
  if (isDatabaseConnected) {
    const checkResult = await checkTransactionCode(code);
    if (checkResult.exists) {
      const t = checkResult.transaction;
      return alert(`‚ùå Code d√©j√† utilis√©!\nCandidat: ${t.candidate_name}\nStatut: ${t.statut}\nDate: ${new Date(t.created_at).toLocaleString()}`);
    }
  }
  
  const voteData = {
    candidate_id: currentCandidateId,
    payment_method: method,
    transaction_code: code,
    vote_count: voteCount
  };
  
  if (isDatabaseConnected) {
    try {
      const result = await fetchAPI('/vote', {
        method: 'POST',
        body: JSON.stringify(voteData)
      });
      
      closePaymentModal();
      alert('‚úÖ ' + result.message);
      await loadCandidates();
      
    } catch (error) {
      console.error('Erreur vote:', error);
      if (error.message.includes('d√©j√† utilis√©') || error.message.includes('409')) {
        alert('‚ùå Code d√©j√† utilis√©!');
      } else if (error.message.includes('termin√©e')) {
        alert('‚è∞ ' + error.message);
        voteActive = false;
        updateCountdown();
      } else {
        alert('‚ùå Erreur: ' + error.message + '\nVote enregistr√© localement.');
        saveVoteLocally(voteData, candidate);
      }
    }
  } else {
    const existingLocal = pendingTransactions.find(t => t.transaction_code === code);
    if (existingLocal) return alert('‚ùå Code d√©j√† utilis√© localement!');
    saveVoteLocally(voteData, candidate);
  }
});

function saveVoteLocally(voteData, candidate) {
  const transaction = {
    ...voteData,
    id: 'local_' + Date.now(),
    candidate_name: candidate.nom,
    created_at: new Date().toISOString(),
    statut: 'pending'
  };
  
  pendingTransactions.push(transaction);
  candidate.votes = (candidate.votes || 0) + voteData.vote_count;
  
  const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
  if (votesBadge) {
    votesBadge.textContent = `Votes: ${candidate.votes}`;
    votesBadge.classList.add('animate');
    setTimeout(() => votesBadge.classList.remove('animate'), 600);
  }
  
  saveLocalData();
  updateTotalVotes();
  updateRanking();
  closePaymentModal();
  alert('‚úÖ Vote enregistr√© localement!');
}

// ============================
// PANEL ADMIN
// ============================
document.querySelector('.admin-btn').addEventListener('click', () => {
  document.getElementById('admin-panel').style.display = 'flex';
});

function closeAdminPanel() {
  document.getElementById('admin-panel').style.display = 'none';
  document.getElementById('admin-content').style.display = 'none';
  document.getElementById('admin-pass').value = '';
  adminToken = null;
}

document.getElementById('admin-login').addEventListener('click', async () => {
  const password = document.getElementById('admin-pass').value;
  if (!password) return alert('Mot de passe requis');
  
  try {
    const result = await fetch(API_BASE_URL + '/admin/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({password: password})
    });
    
    if (result.ok) {
      const data = await result.json();
      adminToken = data.token;
      document.getElementById('admin-content').style.display = 'block';
      await refreshPendingTransactions();
    } else {
      const error = await result.json();
      alert('Erreur: ' + (error.error || 'Mot de passe incorrect'));
    }
  } catch (error) {
    if (password === '2025') {
      adminToken = 'local_token';
      document.getElementById('admin-content').style.display = 'block';
      refreshPendingTransactions();
    } else {
      alert('Mot de passe incorrect');
    }
  }
});

async function refreshPendingTransactions() {
  const section = document.getElementById('pending-list-section');
  section.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Chargement...</div>';
  
  try {
    if (isDatabaseConnected && adminToken) {
      const transactions = await fetchAPI('/admin/transactions/pending');
      displayTransactions(transactions, true);
    } else {
      loadLocalTransactions();
      displayTransactions(pendingTransactions, false);
    }
  } catch (error) {
    console.error('Erreur transactions:', error);
    section.innerHTML = `
      <div class="warning-box">
        ‚ùå Erreur: ${error.message}<br>
        <button onclick="refreshPendingTransactions()" style="margin-top:10px;padding:8px 16px;background:var(--accent-2);color:white;border:none;border-radius:8px;cursor:pointer;">
          R√©essayer
        </button>
      </div>
    `;
  }
}

function displayTransactions(transactions, fromAPI = true) {
  const section = document.getElementById('pending-list-section');
  
  if (transactions && transactions.length > 0) {
    section.innerHTML = transactions.map((t, index) => {
      const transactionId = fromAPI ? t.id : index;
      const apiCall = fromAPI ? 'validateAPITransaction' : 'validateLocalTransaction';
      const rejectCall = fromAPI ? 'rejectAPITransaction' : 'rejectLocalTransaction';
      const candidateNumber = t.candidate_number || extractCandidateNumber(t.candidate_id);
      
      return `
        <div class="admin-card">
          <div>
            <strong>Candidat N¬∞${candidateNumber}</strong><br>
            <strong>${t.candidate_name || t.nom || 'Candidat inconnu'}</strong><br>
            ${t.nombre_votes || t.vote_count || 1} vote(s) ‚Äî ${t.methode_paiement || t.payment_method || 'N/A'}<br>
            Code: <strong>${t.code_transaction || t.transaction_code || 'N/A'}</strong><br>
            <small>${new Date(t.created_at).toLocaleString()}</small>
          </div>
          <div>
            <button onclick="${apiCall}(${transactionId})">Valider</button>
            <button class="reject" onclick="${rejectCall}(${transactionId})">Rejeter</button>
          </div>
        </div>
      `;
    }).join('');
  } else {
    section.innerHTML = '<div class="loading">‚úÖ Aucune transaction en attente</div>';
  }
}

function loadLocalTransactions() {
  try {
    const saved = localStorage.getItem('ahn_pending_transactions');
    if (saved) pendingTransactions = JSON.parse(saved);
  } catch (error) {
    console.log('Pas de transactions locales');
  }
}

async function validateAPITransaction(transactionId) {
  if (!confirm('Valider cette transaction ?')) return;
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/validate`, {method: 'POST'});
    alert('‚úÖ Transaction valid√©e!');
    await refreshPendingTransactions();
    await loadCandidates();
  } catch (error) {
    alert('‚ùå Erreur: ' + error.message);
  }
}

async function rejectAPITransaction(transactionId) {
  if (!confirm('Rejeter cette transaction ?')) return;
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/reject`, {method: 'POST'});
    alert('‚úÖ Transaction rejet√©e!');
    await refreshPendingTransactions();
  } catch (error) {
    alert('‚ùå Erreur: ' + error.message);
  }
}

function validateLocalTransaction(index) {
  if (!confirm('Valider cette transaction locale ?')) return;
  pendingTransactions.splice(index, 1);
  saveLocalData();
  refreshPendingTransactions();
  alert('‚úÖ Transaction valid√©e localement!');
}

function rejectLocalTransaction(index) {
  if (!confirm('Rejeter cette transaction locale ?\nLes votes seront retir√©s.')) return;
  const transaction = pendingTransactions[index];
  if (transaction) {
    const candidate = allCandidates.find(c => c.id === transaction.candidate_id);
    if (candidate) {
      candidate.votes = Math.max(0, (candidate.votes || 0) - (transaction.vote_count || 1));
      const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
      if (votesBadge) votesBadge.textContent = `Votes: ${candidate.votes}`;
    }
    pendingTransactions.splice(index, 1);
    saveLocalData();
    refreshPendingTransactions();
    updateTotalVotes();
    updateRanking();
  }
  alert('‚úÖ Transaction rejet√©e localement!');
}

// ============================
// DONN√âES LOCALES
// ============================
function saveLocalData() {
  try {
    localStorage.setItem('ahn_candidates', JSON.stringify(allCandidates));
    localStorage.setItem('ahn_pending_transactions', JSON.stringify(pendingTransactions));
    localStorage.setItem('ahn_last_save', new Date().toISOString());
  } catch (error) {
    console.error('Sauvegarde locale:', error);
  }
}

// ============================
// INITIALISATION
// ============================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ D√©marrage...');
  console.log(`üåê API: ${API_BASE_URL}`);
  console.log(`üñºÔ∏è Images: ${IMAGES_BASE_PATH}`);
  console.log(`‚è∞ Date limite: ${VOTE_DEADLINE.toLocaleString('fr-FR')}`);
  
  // D√©marrer le compte √† rebours
  startCountdown();
  
  // Tester une image
  const testImg = new Image();
  testImg.onload = () => console.log('‚úÖ Test image charg√©e');
  testImg.onerror = () => console.log('‚ùå Test image √©chou√©e');
  testImg.src = IMAGES_BASE_PATH + 'miss_1.jpg';
  
  loadLocalTransactions();
  await loadCandidates();
  
  // V√©rifier p√©riodiquement la connexion
  setInterval(async () => {
    await testConnection();
  }, 30000);
});

window.addEventListener('online', async () => {
  console.log('Connexion r√©tablie...');
  const wasConnected = isDatabaseConnected;
  await testConnection();
  
  if (isDatabaseConnected && !wasConnected && pendingTransactions.length > 0) {
    if (confirm('Connexion r√©tablie ! Synchroniser les votes locaux ?')) {
      alert(`${pendingTransactions.length} votes √† synchroniser.`);
    }
  }
});
</script>
</body>
</html>
