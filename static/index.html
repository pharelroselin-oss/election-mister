<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Miss & Mister Arts et Humanit√©s Num√©riques 2026 ‚Äî Vote</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ====== RESET ET VARIABLES GLOBALES ====== */
:root {
  --bg: #f4f7fb;
  --card: #ffffff;
  --muted: #6b7280;
  --accent-1: #ff7a00;
  --accent-2: #3b6bf0;
  --accent-3: #ff3c78;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --glass: rgba(255, 255, 255, 0.85);
  --shadow-sm: rgba(0, 0, 0, 0.05);
  --shadow-md: rgba(0, 0, 0, 0.1);
  --shadow-lg: rgba(0, 0, 0, 0.15);
  --shadow-xl: rgba(0, 0, 0, 0.2);
  
  /* Tailles responsives */
  --space-xs: 0.25rem;
  --space-sm: 0.5rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;
  --space-2xl: 3rem;
  
  /* Breakpoints */
  --bp-mobile: 320px;
  --bp-phablet: 480px;
  --bp-tablet: 768px;
  --bp-laptop: 1024px;
  --bp-desktop: 1280px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  background: var(--bg);
  color: #0f172a;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.5;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ====== TYPOGRAPHIE RESPONSIVE ====== */
h1, h2, h3, h4 {
  font-weight: 700;
  line-height: 1.2;
}

h1 {
  font-size: clamp(1.75rem, 5vw, 2.8rem);
  margin-bottom: var(--space-sm);
}

h2 {
  font-size: clamp(1.25rem, 4vw, 1.75rem);
  margin-bottom: var(--space-md);
}

h3 {
  font-size: clamp(1rem, 3vw, 1.25rem);
}

.subtitle {
  font-size: clamp(0.9rem, 3vw, 1.3rem);
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: var(--space-lg);
}

/* ====== LAYOUT RESPONSIVE ====== */
.page {
  max-width: min(1200px, 95vw);
  margin: 0 auto;
  padding: clamp(0.75rem, 3vw, 1.25rem);
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: clamp(1rem, 3vw, 1.5rem);
  margin-top: clamp(1.5rem, 4vw, 2.5rem);
}

/* ====== HERO RESPONSIVE ====== */
header.hero {
  position: relative;
  border-radius: clamp(16px, 4vw, 24px);
  padding: clamp(2rem, 6vw, 3.75rem) clamp(1rem, 4vw, 1.25rem);
  text-align: center;
  color: white;
  background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3), var(--accent-1));
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  box-shadow: 0 clamp(8px, 2vw, 12px) clamp(20px, 4vw, 40px) var(--shadow-xl);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
  overflow: hidden;
}

/* ====== LOGO SITE ====== */
.logo-container {
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  text-align: center;
  animation: fadeInDown 0.8s ease-out;
}

.site-logo {
  height: clamp(60px, 12vw, 90px);
  width: auto;
  max-width: min(300px, 80vw);
  object-fit: contain;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
  border-radius: 12px;
  transition: transform 0.3s ease, filter 0.3s ease;
}

.site-logo:hover {
  transform: scale(1.05);
  filter: drop-shadow(0 6px 20px rgba(0, 0, 0, 0.35));
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Ajustement pour mobile */
@media (max-width: 480px) {
  .site-logo {
    height: clamp(50px, 10vw, 70px);
  }
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.hero .meta {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: clamp(1rem, 4vw, 2.5rem);
  font-weight: 700;
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
}

/* ====== COMPTE √Ä REBOURS ULTRA RESPONSIVE ====== */
.countdown-container {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  border-radius: clamp(12px, 3vw, 16px);
  padding: clamp(1rem, 3vw, 1.25rem);
  margin: clamp(1rem, 3vw, 1.25rem) auto;
  max-width: min(600px, 90vw);
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.countdown-title {
  font-size: clamp(0.9rem, 3vw, 1.2rem);
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: clamp(0.5rem, 2vw, 0.625rem);
}

.countdown-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: clamp(0.5rem, 2vw, 0.9375rem);
}

@media (max-width: 480px) {
  .countdown-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.countdown-item {
  background: rgba(255, 255, 255, 0.2);
  border-radius: clamp(8px, 2vw, 12px);
  padding: clamp(0.75rem, 2vw, 0.9375rem);
  text-align: center;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.countdown-value {
  font-size: clamp(1.5rem, 6vw, 2.5rem);
  font-weight: 800;
  line-height: 1;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  letter-spacing: -0.5px;
}

.countdown-label {
  font-size: clamp(0.7rem, 2vw, 0.9rem);
  margin-top: clamp(0.25rem, 1vw, 0.3125rem);
  opacity: 0.9;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.vote-ended {
  background: rgba(220, 53, 69, 0.2);
  border: 2px solid var(--danger);
  padding: clamp(1rem, 3vw, 1.25rem);
  border-radius: clamp(12px, 3vw, 16px);
  margin: clamp(1rem, 3vw, 1.25rem) auto;
  max-width: min(600px, 90vw);
  text-align: center;
  font-weight: 600;
  font-size: clamp(0.9rem, 3vw, 1.2rem);
}

/* ====== CARTES CANDIDATS RESPONSIVE ====== */
.card {
  background: var(--card);
  border-radius: clamp(16px, 3vw, 20px);
  padding: clamp(1rem, 3vw, 2rem);
  box-shadow: 0 clamp(8px, 2vw, 12px) clamp(24px, 4vw, 36px) var(--shadow-md);
}

.candidates {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(280px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.5rem);
}

@media (max-width: 480px) {
  .candidates {
    grid-template-columns: 1fr;
  }
}

.candidate {
  background: #fff;
  border-radius: clamp(12px, 3vw, 20px);
  overflow: hidden;
  box-shadow: 0 clamp(4px, 1vw, 8px) clamp(12px, 2vw, 20px) var(--shadow-md);
  display: flex;
  flex-direction: column;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  height: 100%;
  min-height: 380px;
}

.candidate:hover {
  transform: translateY(-8px);
  box-shadow: 0 clamp(12px, 2vw, 20px) clamp(24px, 4vw, 40px) var(--shadow-lg);
}

/* ====== CONTENEUR IMAGE PERFECT ====== */
.thumb {
  width: 100%;
  height: clamp(220px, 50vw, 280px);
  min-height: 220px;
  background: linear-gradient(135deg, #eef6ff, #dbeafe);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.thumb::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3));
  z-index: 2;
}

.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center top; /* Focus sur le visage */
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.candidate:hover .thumb img {
  transform: scale(1.05);
}

/* Assurance que les visages sont toujours entiers */
.image-container {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.image-container img {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-width: 100%;
  min-height: 100%;
  object-fit: cover;
}

/* Badge num√©ro de candidat */
.candidate-number {
  position: absolute;
  top: clamp(8px, 2vw, 10px);
  left: clamp(8px, 2vw, 10px);
  background: var(--accent-1);
  color: white;
  width: clamp(32px, 6vw, 36px);
  height: clamp(32px, 6vw, 36px);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: clamp(0.9rem, 2vw, 1.1rem);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  z-index: 10;
  border: 2px solid white;
}

/* ====== INFO CANDIDAT RESPONSIVE ====== */
.info {
  padding: clamp(1rem, 3vw, 1.25rem);
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: clamp(0.5rem, 2vw, 0.75rem);
}

.info h3 {
  display: flex;
  flex-direction: column;
  gap: clamp(0.25rem, 1vw, 0.375rem);
}

.number-badge {
  background: var(--accent-1);
  color: white;
  padding: clamp(0.25rem, 1vw, 0.375rem) clamp(0.5rem, 2vw, 0.75rem);
  border-radius: clamp(8px, 2vw, 12px);
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  font-weight: 700;
  display: inline-block;
  align-self: flex-start;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.votes-badge {
  font-weight: 700;
  color: var(--accent-2);
  font-size: clamp(0.85rem, 2vw, 1rem);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.votes-badge::before {
  content: 'üéØ';
  font-size: 1.1em;
}

.votes-badge.animate {
  transform: scale(1.1);
  color: var(--accent-3);
}

/* EXCEPTION UNIQUEMENT POUR L'IMAGE MASS_3 */
.thumb img[src*="/static/photo/mass_3.jpg"],
.thumb img[src$="mass_3.jpg"],
.thumb img[alt*="ULRICH MBAKONG"] { /* Ciblage par nom aussi */
  object-position: 10% 7% !important; /* Haut gauche */
  transform: translate(-50%, -45%) scale(1.1) !important; /* Remont√© */
}

.candidate:hover .thumb img[src*="/static/photo/mass_3.jpg"],
.candidate:hover .thumb img[src$="mass_3.jpg"],
.candidate:hover .thumb img[alt*="ULRICH MBAKONG"] {
  transform: translate(-50%, -45%) scale(1.15) !important;
}

/* ====== BOUTONS RESPONSIVE ====== */
.actions {
  display: flex;
  justify-content: flex-end;
  margin-top: clamp(0.75rem, 2vw, 1rem);
}

.vote-btn {
  padding: clamp(0.75rem, 2vw, 0.875rem) clamp(1rem, 3vw, 1.25rem);
  background: linear-gradient(90deg, var(--accent-1), var(--accent-3));
  border: none;
  color: white;
  font-weight: 700;
  font-size: clamp(0.85rem, 2vw, 1rem);
  border-radius: clamp(10px, 2vw, 14px);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  width: 100%;
  max-width: 150px;
  position: relative;
  overflow: hidden;
}

.vote-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s;
}

.vote-btn:hover::after {
  left: 100%;
}

.vote-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.vote-btn:active {
  transform: translateY(0);
}

.vote-btn:disabled {
  background: #cbd5e1;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ====== CLASSEMENT RESPONSIVE ====== */
#ranking {
  margin-top: clamp(1.5rem, 4vw, 2rem);
}

.ranking-item {
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  padding: clamp(0.75rem, 2vw, 1rem);
  background: #fff;
  border-radius: clamp(10px, 2vw, 12px);
  box-shadow: 0 4px 12px var(--shadow-sm);
  transition: all 0.3s;
}

.ranking-info {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: clamp(0.5rem, 2vw, 0.75rem);
  margin-bottom: clamp(0.5rem, 2vw, 0.625rem);
}

.ranking-rank {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: clamp(28px, 5vw, 32px);
  height: clamp(28px, 5vw, 32px);
  background: var(--accent-1);
  color: white;
  border-radius: 50%;
  font-weight: 800;
  font-size: clamp(0.85rem, 2vw, 1rem);
  flex-shrink: 0;
}

.ranking-rank.rank-1 { background: #ffd700; color: #000; }
.ranking-rank.rank-2 { background: #c0c0c0; color: #000; }
.ranking-rank.rank-3 { background: #cd7f32; color: #000; }

.ranking-candidate-number {
  background: var(--accent-2);
  color: white;
  padding: clamp(0.125rem, 1vw, 0.1875rem) clamp(0.5rem, 2vw, 0.75rem);
  border-radius: clamp(6px, 2vw, 8px);
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  font-weight: 700;
}

.ranking-bar-container {
  width: 100%;
  height: clamp(10px, 3vw, 14px);
  background: #e9ecef;
  border-radius: clamp(6px, 2vw, 8px);
  overflow: hidden;
  margin-top: clamp(0.375rem, 1vw, 0.5rem);
}

.ranking-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
  border-radius: inherit;
  transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ====== BOUTON ADMIN RESPONSIVE ====== */
.admin-btn {
  position: absolute;
  top: clamp(0.75rem, 3vw, 1.25rem);
  right: clamp(0.75rem, 3vw, 1.25rem);
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(6px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: clamp(0.5rem, 2vw, 0.75rem) clamp(0.75rem, 3vw, 1.25rem);
  border-radius: clamp(10px, 2vw, 14px);
  font-weight: 700;
  font-size: clamp(0.8rem, 2vw, 1rem);
  cursor: pointer;
  transition: all 0.3s;
  z-index: 100;
}

.admin-btn:hover {
  background: rgba(255, 255, 255, 0.4);
  transform: scale(1.05);
}

/* ====== MODALS RESPONSIVE ====== */
#payment-modal,
#admin-panel {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.3s;
  padding: clamp(0.5rem, 3vw, 1rem);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  width: min(450px, 95vw);
  padding: clamp(1rem, 4vw, 2rem);
  border-radius: clamp(16px, 3vw, 20px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content h3 {
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  color: var(--accent-2);
}

.modal-content label {
  margin-top: clamp(0.75rem, 2vw, 1rem);
  display: block;
  font-weight: 600;
  font-size: clamp(0.85rem, 2vw, 1rem);
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: clamp(0.75rem, 2vw, 1rem);
  border-radius: clamp(8px, 2vw, 10px);
  border: 2px solid #e2e8f0;
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  font-size: clamp(0.9rem, 2vw, 1rem);
  transition: border-color 0.3s;
}

.modal-content input:focus,
.modal-content select:focus {
  outline: none;
  border-color: var(--accent-2);
  box-shadow: 0 0 0 3px rgba(59, 107, 240, 0.1);
}

.modal-content button {
  padding: clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.25rem);
  width: 100%;
  border-radius: clamp(10px, 2vw, 14px);
  border: none;
  background: var(--accent-2);
  color: white;
  font-weight: 700;
  font-size: clamp(0.9rem, 2vw, 1rem);
  cursor: pointer;
  transition: all 0.3s;
  margin-top: clamp(0.5rem, 2vw, 0.75rem);
}

.modal-content button:hover {
  transform: scale(1.02);
  background: var(--accent-1);
}

#payment-number {
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  font-weight: 600;
  font-size: clamp(0.85rem, 2vw, 1rem);
  color: var(--accent-2);
}

/* ====== SECTION ADMIN RESPONSIVE ====== */
.admin-section {
  margin-top: clamp(1rem, 3vw, 1.5rem);
  max-height: 50vh;
  overflow-y: auto;
}

.admin-card {
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  padding: clamp(0.75rem, 2vw, 1rem);
  border: 2px solid #e2e8f0;
  border-radius: clamp(8px, 2vw, 12px);
  display: flex;
  flex-direction: column;
  gap: clamp(0.5rem, 2vw, 0.75rem);
  transition: all 0.3s;
}

@media (min-width: 480px) {
  .admin-card {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
}

.admin-card button {
  padding: clamp(0.5rem, 2vw, 0.625rem) clamp(0.75rem, 2vw, 1rem);
  border: none;
  background: var(--accent-2);
  color: white;
  border-radius: clamp(6px, 2vw, 8px);
  cursor: pointer;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  font-weight: 600;
  transition: all 0.3s;
  flex: 1;
}

@media (min-width: 480px) {
  .admin-card button {
    flex: 0;
    min-width: 80px;
  }
}

.admin-card button.reject {
  background: var(--danger);
}

.admin-card button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* ====== FOOTER RESPONSIVE ====== */
footer {
  text-align: center;
  margin-top: clamp(2rem, 5vw, 3rem);
  color: var(--muted);
  padding: clamp(1rem, 3vw, 1.5rem);
  border-top: 2px solid #e2e8f0;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
}

footer a {
  color: var(--accent-2);
  text-decoration: none;
  transition: color 0.3s;
}

footer a:hover {
  color: var(--accent-1);
  text-decoration: underline;
}

/* ====== LOADING STATES ====== */
.loading {
  text-align: center;
  padding: clamp(2rem, 5vw, 3rem);
  color: var(--muted);
}

.loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--accent-2);
  border-radius: 50%;
  width: clamp(32px, 6vw, 40px);
  height: clamp(32px, 6vw, 40px);
  animation: spin 1s linear infinite;
  margin: 0 auto clamp(1rem, 3vw, 1.5rem);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ====== STATUS BADGE ====== */
.status-badge {
  position: fixed;
  top: clamp(0.5rem, 2vw, 0.75rem);
  right: clamp(0.5rem, 2vw, 0.75rem);
  z-index: 1000;
  padding: clamp(0.5rem, 2vw, 0.625rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: clamp(16px, 3vw, 20px);
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 600;
  background: #d4edda;
  color: #155724;
  border: 2px solid #c3e6cb;
  backdrop-filter: blur(10px);
}

.status-badge.offline {
  background: #f8d7da;
  color: #721c24;
  border-color: #f5c6cb;
}

.status-badge.connecting {
  background: #fff3cd;
  color: #856404;
  border-color: #ffeaa7;
}

/* ====== WARNING BOX ====== */
.warning-box {
  background: #fff3cd;
  color: #856404;
  border: 2px solid #ffeaa7;
  padding: clamp(0.75rem, 3vw, 1rem);
  border-radius: clamp(8px, 2vw, 12px);
  margin: clamp(0.75rem, 3vw, 1rem) 0;
  text-align: center;
  font-size: clamp(0.85rem, 2vw, 1rem);
}

/* ====== ANIMATIONS SUPPLEMENTAIRES ====== */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.pulse {
  animation: pulse 2s infinite;
}

/* ====== TOUCH OPTIMIZATIONS ====== */
@media (hover: none) {
  .candidate:hover {
    transform: none;
  }
  
  .vote-btn:hover {
    transform: none;
  }
  
  .admin-btn:hover {
    transform: none;
  }
}

/* ====== DARK MODE SUPPORT ====== */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --muted: #94a3b8;
    --shadow-sm: rgba(0, 0, 0, 0.3);
    --shadow-md: rgba(0, 0, 0, 0.4);
    --shadow-lg: rgba(0, 0, 0, 0.5);
    --shadow-xl: rgba(0, 0, 0, 0.6);
  }
  
  body {
    color: #f1f5f9;
  }
  
  .candidate {
    background: #1e293b;
  }
  
  .thumb {
    background: linear-gradient(135deg, #1e40af, #1d4ed8);
  }
  
  .ranking-item {
    background: #1e293b;
  }
  
  .modal-content {
    background: #1e293b;
    color: #f1f5f9;
  }
  
  .modal-content input,
  .modal-content select {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
  }
}

/* ====== ORIENTATION SUPPORT ====== */
@media (orientation: landscape) and (max-height: 600px) {
  .hero {
    padding: 1.5rem;
  }
  
  .thumb {
    height: 180px;
    min-height: 180px;
  }
  
  .candidate {
    min-height: 320px;
  }
}

/* ====== HIGH-DPI SCREENS ====== */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .thumb img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
}

/* ====== PRINT STYLES ====== */
@media print {
  .admin-btn,
  .vote-btn,
  #payment-modal,
  #admin-panel,
  .status-badge {
    display: none !important;
  }
  
  .candidate {
    break-inside: avoid;
  }
}
</style>
</head>
<body>
<div id="status-badge" class="status-badge connecting">‚è≥ Connexion...</div>

<div class="page">
<header class="hero">
<h1>Miss & Mister AHN 2026</h1>
<div class="logo-container">
  <img src="/static/photo/logo.jpg" alt="Logo AHN" class="site-logo">
</div>

<div class="subtitle">Votez pour vos candidats pr√©f√©r√©s ! Chaque vote compte</div>
<div class="meta">
<div>üé≠ <strong id="candidates-count">0</strong> Candidats</div>
<div>üó≥Ô∏è <strong id="votes-count">0</strong> Votes</div>
<div>üí∞ 100 FCFA / vote</div>
</div>

<!-- Compte √† rebours -->
<div id="countdown" class="countdown-container">
  <div class="countdown-title">
    <span>‚è≥ TEMPS RESTANT POUR VOTER</span>
  </div>
  <div class="countdown-grid">
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-days">00</div>
      <div class="countdown-label">JOURS</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-hours">00</div>
      <div class="countdown-label">HEURES</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-minutes">00</div>
      <div class="countdown-label">MINUTES</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-value" id="countdown-seconds">00</div>
      <div class="countdown-label">SECONDES</div>
    </div>
  </div>
</div>

<div id="vote-ended" class="vote-ended" style="display:none;">
  ‚è∞ <strong>LES VOTES SONT TERMIN√âS</strong><br>
  La p√©riode de vote s'est achev√©e le 20 d√©cembre 2025 √† 21h00
</div>

<button class="admin-btn">üîê Admin</button>
</header>

<div id="connection-warning" class="warning-box" style="display:none;">
‚ö†Ô∏è <strong>Mode local activ√©</strong> - Connexion √† la base de donn√©es indisponible. Les votes seront synchronis√©s plus tard.
</div>

<div class="grid">
<main>
<div class="card">
<h2 style="color:var(--accent-2);margin-bottom:12px;">üëë Candidates Miss</h2>
<div class="candidates" id="miss-list">
  <div class="loading"><div class="loading-spinner"></div>Chargement des candidates...</div>
</div>
<h2 style="color:var(--accent-2);margin-top:32px;margin-bottom:12px;">ü§µ Candidats Mister</h2>
<div class="candidates" id="mister-list">
  <div class="loading"><div class="loading-spinner"></div>Chargement des candidats...</div>
</div>

<div id="ranking-section">
  <h2 style="color:var(--accent-3);margin-top:32px;">üèÜ Classement g√©n√©ral</h2>
  <div id="ranking">
    <div class="loading">Calcul du classement...</div>
  </div>
  
  <div style="margin-top:40px;">
    <h2 style="color:#ff3c78;margin-bottom:20px;">üëë Classement des Candidates Miss</h2>
    <div id="miss-ranking">
      <div class="loading">Calcul du classement Miss...</div>
    </div>
  </div>
  
  <div style="margin-top:40px;">
    <h2 style="color:#3b6bf0;margin-bottom:20px;">ü§µ Classement des Candidats Mister</h2>
    <div id="mister-ranking">
      <div class="loading">Calcul du classement Mister...</div>
    </div>
  </div>
</div>

</div>
</main>
</div>
<footer>
<div>¬© Comit√© de Parrainage Arts et Humanit√©s Num√©riques 2030</div>
<div style="margin-top:10px;font-size:0.9rem;color:#666;">
  Date limite : 20 d√©cembre 2025 √† 21h00 (Heure Cameroun)
</footer>
</div>

<!-- Payment Modal -->
<div id="payment-modal">
<div class="modal-content">
<h3>üí∞ Paiement pour le vote</h3>
<label>Nombre de votes :</label>
<input type="number" id="vote-count" min="0" value="0" placeholder="0"><label>Montant √† payer :</label>
<input type="text" id="payment-amount" value="100 FCFA" readonly>
<label>Moyen de paiement :</label>
<select id="payment-method">
<option value="orange_money">Orange Money</option>
</select>
<div id="payment-number">Num√©ro Orange Money : #150*46*0761200#    NGNEJEUCHOM NOUPELE MAURICE RAYANN</div>
<label>Code transaction :</label>
<input type="text" id="payment-code" placeholder="Entrez le code re√ßu par SMS" autocomplete="off">
<button id="submit-payment">‚úÖ Envoyer pour validation</button>
<button style="background:#eee;color:#333;" onclick="closePaymentModal()">‚ùå Annuler</button>
</div>
</div>

<!-- Admin Panel -->
<div id="admin-panel">
<div class="modal-content">
<h2 style="color:var(--accent-2);">üîê Panneau Admin</h2>
<label>Mot de passe :</label>
<input type="password" id="admin-pass" autocomplete="current-password">
<button id="admin-login">Se connecter</button>
<div id="admin-content" style="display:none;">
<h3 style="margin-top:20px;">üìã Transactions en attente</h3>
<div class="admin-section" id="pending-list-section">
  <div class="loading">Chargement des transactions...</div>
</div>
</div>
<button onclick="closeAdminPanel()" style="margin-top:20px;">Fermer</button>
</div>
</div>

<script>
// ============================
// CONFIGURATION
// ============================
const API_BASE_URL = window.location.origin + '/api';
const IMAGES_BASE_PATH = '/static/photo/';
const PRICE_PER_VOTE = 100;
const VOTE_DEADLINE = new Date('2025-12-20T21:00:00+01:00'); // 21h00 Cameroun (UTC+1)

let allCandidates = [];
let pendingTransactions = [];
let currentCandidateId = null;
let isDatabaseConnected = false;
let adminToken = null;
let voteActive = true;
let countdownInterval = null;

// ============================
// COMPTE √Ä REBOURS
// ============================
function updateCountdown() {
  const now = new Date();
  const timeRemaining = VOTE_DEADLINE - now;
  
  if (timeRemaining <= 0) {
    voteActive = false;
    document.getElementById('countdown').style.display = 'none';
    document.getElementById('vote-ended').style.display = 'block';
    
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.disabled = true;
      btn.textContent = '‚è∞ Vote termin√©';
      btn.style.background = '#94a3b8';
    });
    
    if (countdownInterval) clearInterval(countdownInterval);
    return;
  }
  
  const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
  const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
  
  document.getElementById('countdown-days').textContent = days.toString().padStart(2, '0');
  document.getElementById('countdown-hours').textContent = hours.toString().padStart(2, '0');
  document.getElementById('countdown-minutes').textContent = minutes.toString().padStart(2, '0');
  document.getElementById('countdown-seconds').textContent = seconds.toString().padStart(2, '0');
  
  const secondsElement = document.getElementById('countdown-seconds');
  secondsElement.style.transform = 'scale(1.1)';
  setTimeout(() => secondsElement.style.transform = 'scale(1)', 300);
}

function startCountdown() {
  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

// ============================
// FONCTIONS UTILITAIRES
// ============================
function extractCandidateNumber(candidateId) {
  if (!candidateId) return '?';
  const matches = candidateId.match(/\d+/g);
  return matches && matches.length > 0 ? matches[matches.length - 1] : '?';
}

async function fetchAPI(endpoint, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 15000);
  
  try {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        ...(adminToken && { 'Authorization': `Bearer ${adminToken}` }),
        ...options.headers
      },
      ...options
    });
    
    clearTimeout(timeoutId);
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') throw new Error('Timeout: Le serveur ne r√©pond pas');
    throw error;
  }
}

async function testConnection() {
  try {
    const data = await fetchAPI('/health');
    updateConnectionStatus(data.database === 'connected');
    return data.database === 'connected';
  } catch (error) {
    console.log('API non disponible:', error.message);
    updateConnectionStatus(false);
    return false;
  }
}

function updateConnectionStatus(connected) {
  const badge = document.getElementById('status-badge');
  const warning = document.getElementById('connection-warning');
  isDatabaseConnected = connected;
  
  if (connected) {
    badge.className = 'status-badge';
    badge.textContent = '‚úÖ Connect√©';
    warning.style.display = 'none';
  } else {
    badge.className = 'status-badge offline';
    badge.textContent = '‚ö†Ô∏è Hors-Ligne';
    warning.style.display = 'block';
  }
}

// ============================
// CHARGEMENT ET AFFICHAGE OPTIMIS√â
// ============================
async function loadCandidates() {
  try {
    const isConnected = await testConnection();
    
    if (isConnected) {
      allCandidates = await fetchAPI('/candidates');
      console.log('Candidats charg√©s:', allCandidates.length);
      
      // Optimisation des images
      preloadCandidateImages();
      
      await Promise.all([loadStats(), loadRanking()]);
    } else {
      const saved = localStorage.getItem('ahn_candidates');
      allCandidates = saved ? JSON.parse(saved) : [];
      updateTotalVotes();
      updateRanking();
    }
    
    displayCandidates();
    
  } catch (error) {
    console.error('Erreur chargement:', error);
    const saved = localStorage.getItem('ahn_candidates');
    allCandidates = saved ? JSON.parse(saved) : [];
    displayCandidates();
    updateTotalVotes();
    updateRanking();
  }
}

function preloadCandidateImages() {
  // Pr√©chargement intelligent des images
  allCandidates.forEach(candidate => {
    if (candidate.img) {
      let imgPath = candidate.img.startsWith('Photo/') 
        ? candidate.img.replace('Photo/', '') 
        : candidate.img;
      
      const imgUrl = IMAGES_BASE_PATH + imgPath;
      const img = new Image();
      img.src = imgUrl;
    }
  });
}

function displayCandidates() {
  document.getElementById('candidates-count').textContent = allCandidates.length;
  
  const missList = document.getElementById('miss-list');
  const misterList = document.getElementById('mister-list');
  
  const missCandidates = allCandidates.filter(c => c.categorie === 'miss');
  const misterCandidates = allCandidates.filter(c => c.categorie === 'mister');
  
  missList.innerHTML = missCandidates.map(createCandidateCard).join('');
  misterList.innerHTML = misterCandidates.map(createCandidateCard).join('');
  
  // Ajout des √©v√©nements avec d√©lai pour performance
  setTimeout(() => {
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (!voteActive) {
          alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
          return;
        }
        openPaymentModal(e.target.closest('.candidate').getAttribute('data-id'));
      });
    });
  }, 50);
}

function createCandidateCard(candidate) {
  const candidateNumber = candidate.candidate_number || extractCandidateNumber(candidate.id);
  
  // Correction du chemin d'image
  let imageFilename = candidate.img || '';
  if (imageFilename.startsWith('Photo/')) {
    imageFilename = imageFilename.replace('Photo/', '');
  }
  
  const imageUrl = imageFilename ? IMAGES_BASE_PATH + imageFilename : null;
  const candidateName = candidate.nom || 'Candidat';
  const initials = candidateName.split(' ').map(w => w[0]).join('').toUpperCase().substr(0, 2);
  
  // Avatar de secours optimis√©
  const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(candidateName)}&background=3b6bf0&color=fff&bold=true&length=2&size=300`;
  
  return `
    <div class="candidate" data-id="${candidate.id}">
      <div class="candidate-number">${candidateNumber}</div>
      <div class="thumb">
        <div class="image-container">
          <img src="${imageUrl || fallbackUrl}" 
               alt="Photo de ${candidateName}"
               loading="lazy"
               decoding="async"
               onerror="this.onerror=null; this.src='${fallbackUrl}'">
        </div>
      </div>
      <div class="info">
        <h3>
          <span class="number-badge">Candidat N¬∞${candidateNumber}</span>
          ${candidateName}
        </h3>
        <div class="votes-badge" data-votes-id="${candidate.id}">${candidate.votes || 0} votes</div>
      </div>
      <div class="actions">
        <button class="vote-btn" ${!voteActive ? 'disabled' : ''}>
          ${voteActive ? 'üó≥Ô∏è Voter' : '‚è∞ Termin√©'}
        </button>
      </div>
    </div>
  `;
}

async function loadStats() {
  try {
    const stats = await fetchAPI('/stats');
    document.getElementById('votes-count').textContent = stats.total_votes || 0;
  } catch (error) {
    console.log('Stats:', error);
    updateTotalVotes();
  }
}

function updateTotalVotes() {
  const total = allCandidates.reduce((sum, c) => sum + (c.votes || 0), 0);
  document.getElementById('votes-count').textContent = total;
}

async function loadRanking() {
  try {
    const ranking = await fetchAPI('/ranking');
    displayRanking(ranking);
    await loadGenderRanking();
  } catch (error) {
    console.log('Classement:', error);
    updateRanking();
  }
}

function updateRanking() {
  const ranking = [...allCandidates]
    .sort((a, b) => (b.votes || 0) - (a.votes || 0))
    .map((c, i) => ({
      ...c,
      rank_position: i + 1,
      candidate_number: c.candidate_number || extractCandidateNumber(c.id)
    }));
  displayRanking(ranking);
  loadGenderRanking();
}

function displayRanking(ranking) {
  const rankingDiv = document.getElementById('ranking');
  
  if (ranking.length > 0) {
    const maxVotes = Math.max(...ranking.map(c => c.votes || 0), 1);
    
    rankingDiv.innerHTML = ranking.map(c => {
      const percentage = ((c.votes || 0) / maxVotes) * 100;
      return `
        <div class="ranking-item">
          <div class="ranking-info">
            <span class="ranking-rank ${c.rank_position <= 3 ? 'rank-' + c.rank_position : ''}">
              ${c.rank_position}
            </span>
            <span class="ranking-candidate-number">N¬∞${c.candidate_number}</span>
            <strong>${c.nom}</strong>
            <span style="margin-left:auto;color:var(--accent-2);font-weight:bold;">
              ${c.votes || 0} votes
            </span>
          </div>
          <div class="ranking-bar-container">
            <div class="ranking-bar" style="width:${percentage}%"></div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    rankingDiv.innerHTML = '<div class="loading">Aucun vote pour le moment</div>';
  }
}

// ============================
// CLASSEMENT PAR GENRE
// ============================
async function loadGenderRanking() {
  try {
    if (isDatabaseConnected) {
      // Charger les classements depuis l'API
      const [missRanking, misterRanking] = await Promise.all([
        fetchAPI('/ranking/miss'),
        fetchAPI('/ranking/mister')
      ]);
      
      displayRankingByGender(missRanking, 'miss-ranking');
      displayRankingByGender(misterRanking, 'mister-ranking');
    } else {
      // Mode hors-ligne : utiliser les donn√©es locales
      const missCandidates = allCandidates
        .filter(c => c.categorie === 'miss')
        .sort((a, b) => (b.votes || 0) - (a.votes || 0))
        .map((c, i) => ({
          ...c,
          rank_position: i + 1,
          candidate_number: c.candidate_number || extractCandidateNumber(c.id)
        }));
      
      const misterCandidates = allCandidates
        .filter(c => c.categorie === 'mister')
        .sort((a, b) => (b.votes || 0) - (a.votes || 0))
        .map((c, i) => ({
          ...c,
          rank_position: i + 1,
          candidate_number: c.candidate_number || extractCandidateNumber(c.id)
        }));
      
      displayRankingByGender(missCandidates, 'miss-ranking');
      displayRankingByGender(misterCandidates, 'mister-ranking');
    }
  } catch (error) {
    console.log('Erreur chargement classement par genre:', error);
    // Afficher message d'erreur
    document.getElementById('miss-ranking').innerHTML = 
      '<div class="loading">Erreur de chargement</div>';
    document.getElementById('mister-ranking').innerHTML = 
      '<div class="loading">Erreur de chargement</div>';
  }
}

function displayRankingByGender(ranking, containerId) {
  const container = document.getElementById(containerId);
  
  if (!container) return;
  
  if (ranking && ranking.length > 0) {
    const maxVotes = Math.max(...ranking.map(c => c.votes || 0), 1);
    
    container.innerHTML = ranking.map(c => {
      const percentage = ((c.votes || 0) / maxVotes) * 100;
      return `
        <div class="ranking-item">
          <div class="ranking-info">
            <span class="ranking-rank ${c.rank_position <= 3 ? 'rank-' + c.rank_position : ''}">
              ${c.rank_position}
            </span>
            <span class="ranking-candidate-number">N¬∞${c.candidate_number}</span>
            <strong>${c.nom}</strong>
            <span style="margin-left:auto;color:var(--accent-2);font-weight:bold;">
              ${c.votes || 0} votes
            </span>
          </div>
          <div class="ranking-bar-container">
            <div class="ranking-bar" style="width:${percentage}%; 
                  ${c.rank_position === 1 ? 'background: linear-gradient(90deg, #ffd700, #ffed4e);' : 
                    c.rank_position === 2 ? 'background: linear-gradient(90deg, #c0c0c0, #e0e0e0);' : 
                    c.rank_position === 3 ? 'background: linear-gradient(90deg, #cd7f32, #e6a157);' : 
                    'background: linear-gradient(90deg, var(--accent-2), var(--accent-1));'}">
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    container.innerHTML = `
      <div style="text-align:center;padding:20px;color:#666;">
        Aucun vote pour le moment
      </div>
    `;
  }
}

// ============================
// GESTION DES VOTES OPTIMIS√âE
// ============================
async function checkTransactionCode(code) {
  if (!code || !isDatabaseConnected) return { exists: false };
  try {
    return await fetchAPI(`/check-transaction/${encodeURIComponent(code)}`);
  } catch (error) {
    console.log('V√©rif code:', error);
    return { exists: false };
  }
}

function openPaymentModal(candidateId) {
  if (!voteActive) {
    alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
    return;
  }
  
  currentCandidateId = candidateId;
  document.getElementById('vote-count').value='';
  document.getElementById('payment-code').value = '';
  document.getElementById('payment-amount').value = ' 0 FCFA';
  updatePaymentNumber();
  document.getElementById('payment-modal').style.display = 'flex';
  document.getElementById('payment-code').focus();
}

function closePaymentModal() {
  document.getElementById('payment-modal').style.display = 'none';
  currentCandidateId = null;
}

document.getElementById('vote-count').addEventListener('input', function() {
  let count = parseInt(this.value) || 0;
  
  // Autoriser 0 et supprimer le contenu
  if (count < 0) count = 0;
  
  // Limite sup√©rieure raisonnable (10000000000 votes max)
  if (count > 10000000000) count = 10000000000;
  
  this.value = count === 0 ? '' : count; // Vide si 0
  document.getElementById('payment-amount').value = 
    count === 0 ? '0 FCFA' : (count * PRICE_PER_VOTE) + " FCFA";
});

// Ajouter aussi pour g√©rer la touche Delete/Backspace
document.getElementById('vote-count').addEventListener('keydown', function(e) {
  if (e.key === 'Delete' || e.key === 'Backspace') {
    setTimeout(() => {
      this.value = this.value === '' ? '' : this.value;
      const count = parseInt(this.value) || 0;
      document.getElementById('payment-amount').value = 
        count === 0 ? '0 FCFA' : (count * PRICE_PER_VOTE) + " FCFA";
    }, 10);
  }
});

function updatePaymentNumber() {
  const method = document.getElementById('payment-method').value;
  let number = '';
  switch(method) {
    case 'orange_money': number = '#150*46*0761200#'; break;
    default: number = '#150*46*0761200#';
  }
  document.getElementById('payment-number').textContent = 'Num√©ro ' + method.replace('_', ' ') + ' : ' + number;
}

document.getElementById('payment-method').addEventListener('change', updatePaymentNumber);

document.getElementById('submit-payment').addEventListener('click', async function() {
  if (!voteActive) {
    alert('‚è∞ Les votes sont termin√©s !\nLa p√©riode de vote s\'est achev√©e le 20 d√©cembre 2025 √† 21h00.');
    closePaymentModal();
    return;
  }
  
  const method = document.getElementById('payment-method').value;
  const code = document.getElementById('payment-code').value.trim();
  const voteCount = parseInt(document.getElementById('vote-count').value) || 1;
  
  if (!code) return alert('Veuillez entrer le code de transaction');
  if (!currentCandidateId) return alert('Erreur: Candidat non s√©lectionn√©');
  
  const candidate = allCandidates.find(c => c.id === currentCandidateId);
  if (!candidate) return alert('Erreur: Candidat introuvable');
  
  // V√©rification du code
  if (isDatabaseConnected) {
    const checkResult = await checkTransactionCode(code);
    if (checkResult.exists) {
      const t = checkResult.transaction;
      return alert(`‚ùå Code d√©j√† utilis√©!\nCandidat: ${t.candidate_name}\nStatut: ${t.statut}\nDate: ${new Date(t.created_at).toLocaleString()}`);
    }
  }
  
  const voteData = {
    candidate_id: currentCandidateId,
    payment_method: method,
    transaction_code: code,
    vote_count: voteCount
  };
  
  if (isDatabaseConnected) {
    try {
      const result = await fetchAPI('/vote', {
        method: 'POST',
        body: JSON.stringify(voteData)
      });
      
      closePaymentModal();
      alert('‚úÖ ' + result.message);
      await loadCandidates();
      
    } catch (error) {
      console.error('Erreur vote:', error);
      if (error.message.includes('d√©j√† utilis√©') || error.message.includes('409')) {
        alert('‚ùå Code d√©j√† utilis√©!');
      } else if (error.message.includes('termin√©e')) {
        alert('‚è∞ ' + error.message);
        voteActive = false;
        updateCountdown();
      } else {
        alert('‚ùå Erreur: ' + error.message + '\nVote enregistr√© localement.');
        saveVoteLocally(voteData, candidate);
      }
    }
  } else {
    const existingLocal = pendingTransactions.find(t => t.transaction_code === code);
    if (existingLocal) return alert('‚ùå Code d√©j√† utilis√© localement!');
    saveVoteLocally(voteData, candidate);
  }
});

function saveVoteLocally(voteData, candidate) {
  const transaction = {
    ...voteData,
    id: 'local_' + Date.now(),
    candidate_name: candidate.nom,
    created_at: new Date().toISOString(),
    statut: 'pending'
  };
  
  pendingTransactions.push(transaction);
  candidate.votes = (candidate.votes || 0) + voteData.vote_count;
  
  const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
  if (votesBadge) {
    votesBadge.textContent = `${candidate.votes} votes`;
    votesBadge.classList.add('animate');
    setTimeout(() => votesBadge.classList.remove('animate'), 600);
  }
  
  saveLocalData();
  updateTotalVotes();
  updateRanking();
  closePaymentModal();
  alert('‚úÖ Vote enregistr√© localement! Il sera synchronis√© lorsque la connexion sera r√©tablie.');
}

// ============================
// PANEL ADMIN
// ============================
document.querySelector('.admin-btn').addEventListener('click', () => {
  document.getElementById('admin-panel').style.display = 'flex';
  document.getElementById('admin-pass').focus();
});

function closeAdminPanel() {
  document.getElementById('admin-panel').style.display = 'none';
  document.getElementById('admin-content').style.display = 'none';
  document.getElementById('admin-pass').value = '';
  adminToken = null;
}

document.getElementById('admin-login').addEventListener('click', async () => {
  const password = document.getElementById('admin-pass').value;
  if (!password) return alert('Mot de passe requis');
  
  try {
    const result = await fetch(API_BASE_URL + '/admin/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({password: password})
    });
    
    if (result.ok) {
      const data = await result.json();
      adminToken = data.token;
      document.getElementById('admin-content').style.display = 'block';
      await refreshPendingTransactions();
    } else {
      const error = await result.json();
      alert('Erreur: ' + (error.error || 'Mot de passe incorrect'));
    }
    } catch (error) {
    alert('Connexion impossible. V√©rifiez votre connexion internet.');
  }
});

async function refreshPendingTransactions() {
  const section = document.getElementById('pending-list-section');
  section.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Chargement...</div>';
  
  try {
    if (isDatabaseConnected && adminToken) {
      const transactions = await fetchAPI('/admin/transactions/pending');
      displayTransactions(transactions, true);
    } else {
      loadLocalTransactions();
      displayTransactions(pendingTransactions, false);
    }
  } catch (error) {
    console.error('Erreur transactions:', error);
    section.innerHTML = `
      <div class="warning-box">
        ‚ùå Erreur: ${error.message}<br>
        <button onclick="refreshPendingTransactions()" style="margin-top:10px;padding:8px 16px;background:var(--accent-2);color:white;border:none;border-radius:8px;cursor:pointer;">
          R√©essayer
        </button>
      </div>
    `;
  }
}

function displayTransactions(transactions, fromAPI = true) {
  const section = document.getElementById('pending-list-section');
  
  if (transactions && transactions.length > 0) {
    section.innerHTML = transactions.map((t, index) => {
      const transactionId = fromAPI ? t.id : index;
      const apiCall = fromAPI ? 'validateAPITransaction' : 'validateLocalTransaction';
      const rejectCall = fromAPI ? 'rejectAPITransaction' : 'rejectLocalTransaction';
      const candidateNumber = t.candidate_number || extractCandidateNumber(t.candidate_id);
      
      return `
        <div class="admin-card">
          <div>
            <strong>Candidat N¬∞${candidateNumber}</strong><br>
            <strong>${t.candidate_name || t.nom || 'Candidat inconnu'}</strong><br>
            ${t.nombre_votes || t.vote_count || 1} vote(s) ‚Äî ${t.methode_paiement || t.payment_method || 'N/A'}<br>
            Code: <strong>${t.code_transaction || t.transaction_code || 'N/A'}</strong><br>
            <small>${new Date(t.created_at).toLocaleString()}</small>
          </div>
          <div style="display:flex;gap:0.5rem;">
            <button onclick="${apiCall}(${transactionId})">‚úÖ Valider</button>
            <button class="reject" onclick="${rejectCall}(${transactionId})">‚ùå Rejeter</button>
          </div>
        </div>
      `;
    }).join('');
  } else {
    section.innerHTML = '<div class="loading">‚úÖ Aucune transaction en attente</div>';
  }
}

function loadLocalTransactions() {
  try {
    const saved = localStorage.getItem('ahn_pending_transactions');
    if (saved) pendingTransactions = JSON.parse(saved);
  } catch (error) {
    console.log('Pas de transactions locales');
  }
}

async function validateAPITransaction(transactionId) {
  if (!confirm('Valider cette transaction ?')) return;
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/validate`, {method: 'POST'});
    alert('‚úÖ Transaction valid√©e!');
    await refreshPendingTransactions();
    await loadCandidates();
  } catch (error) {
    alert('‚ùå Erreur: ' + error.message);
  }
}

async function rejectAPITransaction(transactionId) {
  if (!confirm('Rejeter cette transaction ?')) return;
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/reject`, {method: 'POST'});
    alert('‚úÖ Transaction rejet√©e!');
    await refreshPendingTransactions();
  } catch (error) {
    alert('‚ùå Erreur: ' + error.message);
  }
}

function validateLocalTransaction(index) {
  if (!confirm('Valider cette transaction locale ?')) return;
  pendingTransactions.splice(index, 1);
  saveLocalData();
  refreshPendingTransactions();
  alert('‚úÖ Transaction valid√©e localement!');
}

function rejectLocalTransaction(index) {
  if (!confirm('Rejeter cette transaction locale ?\nLes votes seront retir√©s.')) return;
  const transaction = pendingTransactions[index];
  if (transaction) {
    const candidate = allCandidates.find(c => c.id === transaction.candidate_id);
    if (candidate) {
      candidate.votes = Math.max(0, (candidate.votes || 0) - (transaction.vote_count || 1));
      const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
      if (votesBadge) votesBadge.textContent = `${candidate.votes} votes`;
    }
    pendingTransactions.splice(index, 1);
    saveLocalData();
    refreshPendingTransactions();
    updateTotalVotes();
    updateRanking();
  }
  alert('‚úÖ Transaction rejet√©e localement!');
}

// ============================
// DONN√âES LOCALES
// ============================
function saveLocalData() {
  try {
    localStorage.setItem('ahn_candidates', JSON.stringify(allCandidates));
    localStorage.setItem('ahn_pending_transactions', JSON.stringify(pendingTransactions));
    localStorage.setItem('ahn_last_save', new Date().toISOString());
  } catch (error) {
    console.error('Sauvegarde locale:', error);
  }
}

// ============================
// INITIALISATION OPTIMIS√âE
// ============================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ D√©marrage application...');
  console.log(`üåê API: ${API_BASE_URL}`);
  console.log(`üñºÔ∏è Images: ${IMAGES_BASE_PATH}`);
  console.log(`‚è∞ Date limite: ${VOTE_DEADLINE.toLocaleString('fr-FR', { timeZone: 'Africa/Douala' })}`);
  
  // D√©marrer le compte √† rebours
  startCountdown();
  
  // Optimisation pour mobile
  if ('connection' in navigator) {
    console.log(`üì∂ Connexion: ${navigator.connection.effectiveType}`);
  }
  
  // Chargement initial
  loadLocalTransactions();
  await loadCandidates();
  
  // V√©rification p√©riodique
  setInterval(async () => {
    await testConnection();
  }, 30000);
  
  // Gestion du clavier mobile
  window.addEventListener('resize', () => {
    if (window.innerHeight < 500) {
      document.body.classList.add('keyboard-open');
    } else {
      document.body.classList.remove('keyboard-open');
    }
  });
});

// Synchronisation quand la connexion revient
let connectionCheck;
window.addEventListener('online', () => {
  console.log('üì± Connexion r√©tablie');
  
  if (connectionCheck) clearTimeout(connectionCheck);
  connectionCheck = setTimeout(async () => {
    const wasConnected = isDatabaseConnected;
    await testConnection();
    
    if (isDatabaseConnected && !wasConnected && pendingTransactions.length > 0) {
      if (confirm('Connexion r√©tablie ! Synchroniser les votes locaux ?')) {
        alert(`${pendingTransactions.length} votes √† synchroniser.`);
      }
    }
  }, 2000);
});

// Pr√©venir la fermeture accidentelle
window.addEventListener('beforeunload', (e) => {
  if (pendingTransactions.length > 0) {
    e.preventDefault();
    e.returnValue = 'Vous avez des votes non synchronis√©s. √ätes-vous s√ªr de vouloir quitter ?';
  }
});
</script>
</body>
</html>
